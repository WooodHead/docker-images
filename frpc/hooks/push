#!/bin/sh

set -e

BUILD_DIR=frp-builds
export LATEST_VERSION=`cat $BUILD_DIR/.LATEST_VERSION`
export VERSION=`cat $BUILD_DIR/.VERSION`

docker push $DOCKER_REPO:v$VERSION

if [ "$VERSION" = "$LATEST_VERSION" ]; then
    docker tag $DOCKER_REPO:v$VERSION $DOCKER_REPO:latest
    docker push $DOCKER_REPO:latest
    docker rmi $DOCKER_REPO:latest > /dev/null
fi

docker rmi $DOCKER_REPO:v$VERSION > /dev/null

arch_all='i386 arm arm64 mips64 mips64le mips mipsle'
for arch in $arch_all; do
    docker push $DOCKER_REPO:$arch-v$VERSION
    if [ "$VERSION" = "$LATEST_VERSION" ]; then
        docker tag $DOCKER_REPO:$arch-v$VERSION $DOCKER_REPO:$arch-latest
        docker push $DOCKER_REPO:$arch-latest
        docker rmi $DOCKER_REPO:$arch-latest > /dev/null
    fi
    docker rmi $DOCKER_REPO:$arch-v$VERSION > /dev/null
done

rm -rf $BUILD_DIR
